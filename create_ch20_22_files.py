"""
æ‰¹é‡ç”Ÿæˆ Ch20-Ch22 çš„æ‰€æœ‰ Jupyter Notebook æª”æ¡ˆ
ä½¿ç”¨æ­¤è…³æœ¬å¿«é€Ÿå»ºç«‹æ‰€æœ‰éœ€è¦çš„æª”æ¡ˆæ¡†æ¶
"""

import json
import os

# Ch20 çš„æ‰€æœ‰æª”æ¡ˆå…§å®¹ï¼ˆé™¤äº†å·²å®Œæˆçš„ README å’Œ 01-lectureï¼‰

CH20_02_WORKED_EXAMPLES = {
    "cells": [
        {
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "# Ch20: ä¾‹å¤–è™•ç†æ©Ÿåˆ¶ - è©³è§£ç¯„ä¾‹\n",
                "\n",
                "## ğŸ“Œ æœ¬æª”æ¡ˆèªªæ˜\n",
                "\n",
                "æœ¬æª”æ¡ˆåŒ…å« **4å€‹è©³ç´°è§£èªªçš„å¯¦å‹™æ¡ˆä¾‹**ï¼Œæ¯å€‹æ¡ˆä¾‹éƒ½æœƒï¼š\n",
                "1. èªªæ˜å•é¡Œæƒ…å¢ƒ\n",
                "2. åˆ†æéœ€æ±‚èˆ‡é™åˆ¶\n",
                "3. é€æ­¥å¯¦ä½œè§£æ±ºæ–¹æ¡ˆ\n",
                "4. æ¸¬è©¦èˆ‡é©—è­‰\n",
                "5. èªªæ˜é—œéµçŸ¥è­˜é»\n",
                "\n",
                "**å­¸ç¿’ç›®æ¨™**ï¼šé€éå¯¦éš›æ¡ˆä¾‹ç†è§£ä¾‹å¤–è™•ç†çš„å¯¦å‹™æ‡‰ç”¨\n",
                "\n",
                "---"
            ]
        },
        {
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## æ¡ˆä¾‹ 1ï¼šä½¿ç”¨è€…è¼¸å…¥é©—è­‰ç³»çµ±\n",
                "\n",
                "### æƒ…å¢ƒ\n",
                "é–‹ç™¼ä¸€å€‹è¨»å†Šç³»çµ±ï¼Œéœ€è¦é©—è­‰ä½¿ç”¨è€…è¼¸å…¥çš„å¹´é½¡ï¼š\n",
                "- å¿…é ˆæ˜¯æ•¸å­—\n",
                "- å¿…é ˆåœ¨ 1-150 ä¹‹é–“\n",
                "- å¿…é ˆæ˜¯æ•´æ•¸\n",
                "- ä½¿ç”¨è€…å¯ä»¥é¸æ“‡é€€å‡º\n",
                "\n",
                "### éœ€æ±‚åˆ†æ\n",
                "1. è™•ç†éæ•¸å­—è¼¸å…¥ (ValueError)\n",
                "2. è™•ç†ç¯„åœéŒ¯èª¤ (è‡ªè¨‚é‚è¼¯)\n",
                "3. è™•ç†ä½¿ç”¨è€…ä¸­æ–· (KeyboardInterrupt)\n",
                "4. æä¾›å‹å–„çš„éŒ¯èª¤è¨Šæ¯\n",
                "5. å…è¨±é‡è©¦"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "metadata": {},
            "outputs": [],
            "source": [
                "def get_age_from_user(max_attempts=3):\n",
                "    \"\"\"\n",
                "    å¾ä½¿ç”¨è€…å–å¾—æœ‰æ•ˆçš„å¹´é½¡è¼¸å…¥\n",
                "    \n",
                "    åƒæ•¸:\n",
                "        max_attempts: æœ€å¤šå˜—è©¦æ¬¡æ•¸\n",
                "    \n",
                "    è¿”å›:\n",
                "        int: æœ‰æ•ˆçš„å¹´é½¡\n",
                "        None: ä½¿ç”¨è€…å–æ¶ˆæˆ–è¶…éå˜—è©¦æ¬¡æ•¸\n",
                "    \"\"\"\n",
                "    attempts = 0\n",
                "    \n",
                "    while attempts < max_attempts:\n",
                "        try:\n",
                "            # 1. å–å¾—è¼¸å…¥\n",
                "            user_input = input(f\"è«‹è¼¸å…¥å¹´é½¡ (1-150) [ç¬¬ {attempts + 1}/{max_attempts} æ¬¡]: \")\n",
                "            \n",
                "            # å…è¨±ä½¿ç”¨è€…è¼¸å…¥ 'q' é€€å‡º\n",
                "            if user_input.lower() == 'q':\n",
                "                print(\"ä½¿ç”¨è€…å–æ¶ˆè¼¸å…¥\")\n",
                "                return None\n",
                "            \n",
                "            # 2. è½‰æ›ç‚ºæ•´æ•¸ï¼ˆå¯èƒ½å¼•ç™¼ ValueErrorï¼‰\n",
                "            age = int(user_input)\n",
                "            \n",
                "            # 3. é©—è­‰ç¯„åœ\n",
                "            if age < 1 or age > 150:\n",
                "                print(f\"âŒ å¹´é½¡å¿…é ˆåœ¨ 1-150 ä¹‹é–“ï¼Œæ‚¨è¼¸å…¥çš„æ˜¯ {age}\")\n",
                "                attempts += 1\n",
                "                continue\n",
                "            \n",
                "            # 4. æˆåŠŸï¼\n",
                "            print(f\"âœ… æˆåŠŸï¼æ‚¨çš„å¹´é½¡æ˜¯ {age} æ­²\")\n",
                "            return age\n",
                "            \n",
                "        except ValueError:\n",
                "            # è™•ç†éæ•¸å­—è¼¸å…¥\n",
                "            print(f\"âŒ éŒ¯èª¤ï¼š'{user_input}' ä¸æ˜¯æœ‰æ•ˆçš„æ•¸å­—\")\n",
                "            attempts += 1\n",
                "            \n",
                "        except KeyboardInterrupt:\n",
                "            # è™•ç† Ctrl+C ä¸­æ–·\n",
                "            print(\"\\nä½¿ç”¨è€…ä¸­æ–·æ“ä½œ\")\n",
                "            return None\n",
                "        \n",
                "        except Exception as e:\n",
                "            # è™•ç†å…¶ä»–æœªé æœŸçš„éŒ¯èª¤\n",
                "            print(f\"âŒ æœªé æœŸçš„éŒ¯èª¤: {type(e).__name__} - {e}\")\n",
                "            attempts += 1\n",
                "    \n",
                "    # è¶…éå˜—è©¦æ¬¡æ•¸\n",
                "    print(f\"âŒ å·²é”åˆ°æœ€å¤šå˜—è©¦æ¬¡æ•¸ ({max_attempts})\")\n",
                "    return None\n",
                "\n",
                "# æ¸¬è©¦ï¼ˆæ‰‹å‹•åŸ·è¡Œï¼‰\n",
                "# age = get_age_from_user()\n",
                "# if age:\n",
                "#     print(f\"\\nè¨»å†ŠæˆåŠŸï¼å¹´é½¡: {age}\")\n",
                "# else:\n",
                "#     print(\"\\nè¨»å†Šå¤±æ•—\")"
            ]
        },
        {
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "### æ¡ˆä¾‹ 1 çŸ¥è­˜é»ç¸½çµ\n",
                "\n",
                "**é—œéµæŠ€å·§**ï¼š\n",
                "1. **å¤šé‡ except é †åº**ï¼šå…·é«”ä¾‹å¤–åœ¨å‰ï¼ˆValueErrorï¼‰â†’ ä¸€èˆ¬ä¾‹å¤–åœ¨å¾Œï¼ˆExceptionï¼‰\n",
                "2. **ä½¿ç”¨è€…å‹å–„**ï¼šæä¾›æ¸…æ¥šçš„éŒ¯èª¤è¨Šæ¯\n",
                "3. **é‡è©¦æ©Ÿåˆ¶**ï¼šå…è¨±ä½¿ç”¨è€…ç³¾æ­£éŒ¯èª¤\n",
                "4. **å„ªé›…é€€å‡º**ï¼šè™•ç† KeyboardInterrupt\n",
                "5. **é˜²ç¦¦æ€§ç¨‹å¼è¨­è¨ˆ**ï¼šæœ€å¾Œç”¨ Exception æ•æ‰æœªé æœŸéŒ¯èª¤\n",
                "\n",
                "**å¸¸è¦‹éŒ¯èª¤**ï¼š\n",
                "- âŒ ä¸æª¢æŸ¥ç¯„åœï¼Œåªæª¢æŸ¥å‹åˆ¥\n",
                "- âŒ ç„¡é™é‡è©¦ï¼ˆæ²’æœ‰ä¸Šé™ï¼‰\n",
                "- âŒ éŒ¯èª¤è¨Šæ¯ä¸æ¸…æ¥š\n",
                "- âŒ æ²’æœ‰è™•ç† KeyboardInterrupt\n",
                "\n",
                "---"
            ]
        },
        {
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## æ¡ˆä¾‹ 2ï¼šæª”æ¡ˆè™•ç†èˆ‡è³‡æºç®¡ç†\n",
                "\n",
                "### æƒ…å¢ƒ\n",
                "å»ºç«‹ä¸€å€‹æ—¥èªŒè¨˜éŒ„ç³»çµ±ï¼Œéœ€è¦ï¼š\n",
                "- è®€å–è¨­å®šæª”\n",
                "- å¯«å…¥æ—¥èªŒæª”\n",
                "- è™•ç†å„ç¨®æª”æ¡ˆéŒ¯èª¤\n",
                "- ç¢ºä¿æª”æ¡ˆä¸€å®šæœƒè¢«é—œé–‰\n",
                "\n",
                "### éœ€æ±‚åˆ†æ\n",
                "1. FileNotFoundError: è¨­å®šæª”ä¸å­˜åœ¨\n",
                "2. PermissionError: æ²’æœ‰å¯«å…¥æ¬Šé™\n",
                "3. OSError: ç£ç¢Ÿç©ºé–“ä¸è¶³ç­‰\n",
                "4. ä½¿ç”¨ finally ç¢ºä¿æª”æ¡ˆé—œé–‰"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "metadata": {},
            "outputs": [],
            "source": [
                "import os\n",
                "from datetime import datetime\n",
                "\n",
                "class SimpleLogger:\n",
                "    \"\"\"\n",
                "    ç°¡å–®çš„æ—¥èªŒè¨˜éŒ„å™¨ï¼Œç¤ºç¯„å®Œæ•´çš„æª”æ¡ˆéŒ¯èª¤è™•ç†\n",
                "    \"\"\"\n",
                "    \n",
                "    def __init__(self, log_file=\"app.log\"):\n",
                "        self.log_file = log_file\n",
                "        self.config = {}\n",
                "        \n",
                "    def load_config(self, config_file=\"config.txt\"):\n",
                "        \"\"\"\n",
                "        è®€å–è¨­å®šæª”\n",
                "        \"\"\"\n",
                "        print(f\"å˜—è©¦è®€å–è¨­å®šæª”: {config_file}\")\n",
                "        \n",
                "        try:\n",
                "            with open(config_file, 'r', encoding='utf-8') as f:\n",
                "                for line in f:\n",
                "                    if '=' in line:\n",
                "                        key, value = line.strip().split('=', 1)\n",
                "                        self.config[key] = value\n",
                "        \n",
                "        except FileNotFoundError:\n",
                "            print(f\"âš ï¸  è¨­å®šæª”ä¸å­˜åœ¨ï¼Œä½¿ç”¨é è¨­è¨­å®š\")\n",
                "            self.config = {'level': 'INFO', 'format': 'simple'}\n",
                "            return False\n",
                "        \n",
                "        except PermissionError:\n",
                "            print(f\"âŒ æ²’æœ‰è®€å–æ¬Šé™: {config_file}\")\n",
                "            return False\n",
                "        \n",
                "        except Exception as e:\n",
                "            print(f\"âŒ è®€å–è¨­å®šæª”å¤±æ•—: {e}\")\n",
                "            return False\n",
                "        \n",
                "        else:\n",
                "            print(f\"âœ… æˆåŠŸè®€å–è¨­å®šæª”ï¼Œå…± {len(self.config)} å€‹è¨­å®š\")\n",
                "            return True\n",
                "    \n",
                "    def write_log(self, message, level=\"INFO\"):\n",
                "        \"\"\"\n",
                "        å¯«å…¥æ—¥èªŒ\n",
                "        \"\"\"\n",
                "        timestamp = datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n",
                "        log_entry = f\"[{timestamp}] {level}: {message}\\n\"\n",
                "        \n",
                "        file_handle = None\n",
                "        \n",
                "        try:\n",
                "            # å˜—è©¦é–‹å•Ÿæª”æ¡ˆ\n",
                "            file_handle = open(self.log_file, 'a', encoding='utf-8')\n",
                "            \n",
                "            # å¯«å…¥å…§å®¹\n",
                "            file_handle.write(log_entry)\n",
                "            \n",
                "            # åˆ·æ–°ç·©è¡å€\n",
                "            file_handle.flush()\n",
                "            \n",
                "        except PermissionError:\n",
                "            print(f\"âŒ æ²’æœ‰å¯«å…¥æ¬Šé™: {self.log_file}\")\n",
                "            return False\n",
                "        \n",
                "        except OSError as e:\n",
                "            # ç£ç¢Ÿç©ºé–“ä¸è¶³ã€æª”æ¡ˆç³»çµ±éŒ¯èª¤ç­‰\n",
                "            print(f\"âŒ ç³»çµ±éŒ¯èª¤: {e}\")\n",
                "            return False\n",
                "        \n",
                "        except Exception as e:\n",
                "            print(f\"âŒ å¯«å…¥æ—¥èªŒå¤±æ•—: {e}\")\n",
                "            return False\n",
                "        \n",
                "        else:\n",
                "            print(f\"âœ… æ—¥èªŒå·²å¯«å…¥: {message}\")\n",
                "            return True\n",
                "        \n",
                "        finally:\n",
                "            # ç¢ºä¿æª”æ¡ˆä¸€å®šæœƒè¢«é—œé–‰\n",
                "            if file_handle is not None:\n",
                "                file_handle.close()\n",
                "                print(\"   æª”æ¡ˆå·²é—œé–‰\")\n",
                "\n",
                "# æ¸¬è©¦\n",
                "logger = SimpleLogger(\"test.log\")\n",
                "\n",
                "# æ¸¬è©¦ 1: è®€å–ä¸å­˜åœ¨çš„è¨­å®šæª”\n",
                "logger.load_config(\"non_existent_config.txt\")\n",
                "\n",
                "# æ¸¬è©¦ 2: å¯«å…¥æ—¥èªŒ\n",
                "logger.write_log(\"ç³»çµ±å•Ÿå‹•\")\n",
                "logger.write_log(\"ä½¿ç”¨è€…ç™»å…¥\", \"INFO\")\n",
                "logger.write_log(\"æ¬Šé™ä¸è¶³\", \"ERROR\")"
            ]
        },
        {
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "### æ¡ˆä¾‹ 2 çŸ¥è­˜é»ç¸½çµ\n",
                "\n",
                "**é—œéµæŠ€å·§**ï¼š\n",
                "1. **try-except-else-finally å®Œæ•´æµç¨‹**\n",
                "   - try: å˜—è©¦æ“ä½œ\n",
                "   - except: è™•ç†éŒ¯èª¤\n",
                "   - else: æˆåŠŸæ™‚åŸ·è¡Œ\n",
                "   - finally: æ¸…ç†è³‡æº\n",
                "\n",
                "2. **æª”æ¡ˆæ“ä½œçš„ä¾‹å¤–éšå±¤**\n",
                "   ```\n",
                "   Exception\n",
                "   â””â”€â”€ OSError\n",
                "         â”œâ”€â”€ FileNotFoundError\n",
                "         â”œâ”€â”€ PermissionError\n",
                "         â”œâ”€â”€ FileExistsError\n",
                "         â””â”€â”€ ...\n",
                "   ```\n",
                "\n",
                "3. **è³‡æºç®¡ç†æœ€ä½³å¯¦è¸**\n",
                "   - å„ªå…ˆä½¿ç”¨ `with` èªå¥ï¼ˆè‡ªå‹•æ¸…ç†ï¼‰\n",
                "   - å¦‚æœä¸èƒ½ç”¨ withï¼Œå¿…é ˆç”¨ finally\n",
                "   - æª¢æŸ¥è³‡æºæ˜¯å¦ç‚º None å†é—œé–‰\n",
                "\n",
                "**æ”¹é€²å»ºè­°**ï¼š\n",
                "```python\n",
                "# æ›´å¥½çš„å¯«æ³•ï¼šä½¿ç”¨ with èªå¥\n",
                "def write_log_better(self, message):\n",
                "    try:\n",
                "        with open(self.log_file, 'a') as f:\n",
                "            f.write(f\"{message}\\n\")\n",
                "    except OSError as e:\n",
                "        print(f\"éŒ¯èª¤: {e}\")\n",
                "        return False\n",
                "    else:\n",
                "        return True\n",
                "```\n",
                "\n",
                "---"
            ]
        },
        {
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## æ¡ˆä¾‹ 3ï¼šç¶²è·¯è«‹æ±‚éŒ¯èª¤è™•ç†\n",
                "\n",
                "### æƒ…å¢ƒ\n",
                "é–‹ç™¼ä¸€å€‹ç°¡å–®çš„ API å®¢æˆ¶ç«¯ï¼Œéœ€è¦è™•ç†ï¼š\n",
                "- ç¶²è·¯é€£ç·šå¤±æ•—\n",
                "- HTTP éŒ¯èª¤ï¼ˆ404, 500 ç­‰ï¼‰\n",
                "- é€¾æ™‚\n",
                "- JSON è§£æéŒ¯èª¤\n",
                "\n",
                "### å¯¦ä½œï¼ˆæ¨¡æ“¬ï¼Œä¸ä½¿ç”¨çœŸå¯¦ç¶²è·¯ï¼‰"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "metadata": {},
            "outputs": [],
            "source": [
                "import json\n",
                "import time\n",
                "\n",
                "class MockHTTPError(Exception):\n",
                "    \"\"\"æ¨¡æ“¬ HTTP éŒ¯èª¤\"\"\"\n",
                "    def __init__(self, status_code, message):\n",
                "        self.status_code = status_code\n",
                "        self.message = message\n",
                "        super().__init__(f\"HTTP {status_code}: {message}\")\n",
                "\n",
                "class MockTimeoutError(Exception):\n",
                "    \"\"\"æ¨¡æ“¬é€¾æ™‚éŒ¯èª¤\"\"\"\n",
                "    pass\n",
                "\n",
                "class MockConnectionError(Exception):\n",
                "    \"\"\"æ¨¡æ“¬é€£ç·šéŒ¯èª¤\"\"\"\n",
                "    pass\n",
                "\n",
                "def mock_api_request(url, simulate_error=None):\n",
                "    \"\"\"\n",
                "    æ¨¡æ“¬ API è«‹æ±‚\n",
                "    \n",
                "    åƒæ•¸:\n",
                "        url: API ç¶²å€\n",
                "        simulate_error: è¦æ¨¡æ“¬çš„éŒ¯èª¤é¡å‹\n",
                "    \"\"\"\n",
                "    if simulate_error == \"timeout\":\n",
                "        raise MockTimeoutError(\"Request timeout after 5 seconds\")\n",
                "    elif simulate_error == \"connection\":\n",
                "        raise MockConnectionError(\"Failed to establish connection\")\n",
                "    elif simulate_error == \"404\":\n",
                "        raise MockHTTPError(404, \"Not Found\")\n",
                "    elif simulate_error == \"500\":\n",
                "        raise MockHTTPError(500, \"Internal Server Error\")\n",
                "    elif simulate_error == \"invalid_json\":\n",
                "        return \"This is not JSON\"  # æœƒå°è‡´ JSON è§£æå¤±æ•—\n",
                "    else:\n",
                "        # æ­£å¸¸å›æ‡‰\n",
                "        return json.dumps({\"status\": \"success\", \"data\": {\"id\": 1, \"name\": \"Test\"}})\n",
                "\n",
                "def fetch_user_data(user_id, retry_count=3):\n",
                "    \"\"\"\n",
                "    ç²å–ä½¿ç”¨è€…è³‡æ–™ï¼ŒåŒ…å«å®Œæ•´çš„éŒ¯èª¤è™•ç†\n",
                "    \"\"\"\n",
                "    url = f\"https://api.example.com/users/{user_id}\"\n",
                "    \n",
                "    for attempt in range(retry_count):\n",
                "        try:\n",
                "            print(f\"\\nå˜—è©¦ {attempt + 1}/{retry_count}: è«‹æ±‚ {url}\")\n",
                "            \n",
                "            # æ¨¡æ“¬è«‹æ±‚ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­ä½¿ç”¨ requests æ¨¡çµ„ï¼‰\n",
                "            # response = mock_api_request(url, simulate_error=\"timeout\")\n",
                "            # response = mock_api_request(url, simulate_error=\"404\")\n",
                "            response = mock_api_request(url)\n",
                "            \n",
                "            # è§£æ JSON\n",
                "            data = json.loads(response)\n",
                "            \n",
                "            # æˆåŠŸ\n",
                "            print(f\"âœ… æˆåŠŸç²å–è³‡æ–™: {data}\")\n",
                "            return data\n",
                "            \n",
                "        except MockTimeoutError:\n",
                "            print(f\"â±ï¸  è«‹æ±‚é€¾æ™‚\")\n",
                "            if attempt < retry_count - 1:\n",
                "                wait_time = 2 ** attempt  # æŒ‡æ•¸é€€é¿\n",
                "                print(f\"   ç­‰å¾… {wait_time} ç§’å¾Œé‡è©¦...\")\n",
                "                time.sleep(wait_time)\n",
                "            continue\n",
                "        \n",
                "        except MockConnectionError as e:\n",
                "            print(f\"ğŸ”Œ é€£ç·šå¤±æ•—: {e}\")\n",
                "            if attempt < retry_count - 1:\n",
                "                print(f\"   ç­‰å¾… 1 ç§’å¾Œé‡è©¦...\")\n",
                "                time.sleep(1)\n",
                "            continue\n",
                "        \n",
                "        except MockHTTPError as e:\n",
                "            # HTTP éŒ¯èª¤é€šå¸¸ä¸æ‡‰è©²é‡è©¦ï¼ˆ404, 403 ç­‰ï¼‰\n",
                "            print(f\"âŒ HTTP éŒ¯èª¤: {e}\")\n",
                "            \n",
                "            if e.status_code >= 500:\n",
                "                # 5xx éŒ¯èª¤å¯ä»¥é‡è©¦\n",
                "                if attempt < retry_count - 1:\n",
                "                    print(f\"   ä¼ºæœå™¨éŒ¯èª¤ï¼Œå°‡é‡è©¦...\")\n",
                "                    time.sleep(2)\n",
                "                    continue\n",
                "            return None  # 4xx éŒ¯èª¤ä¸é‡è©¦\n",
                "        \n",
                "        except json.JSONDecodeError as e:\n",
                "            print(f\"âŒ JSON è§£æå¤±æ•—: {e}\")\n",
                "            return None\n",
                "        \n",
                "        except Exception as e:\n",
                "            print(f\"âŒ æœªé æœŸçš„éŒ¯èª¤: {type(e).__name__} - {e}\")\n",
                "            return None\n",
                "    \n",
                "    # æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—\n",
                "    print(f\"âŒ å·²é”åˆ°æœ€å¤šé‡è©¦æ¬¡æ•¸ ({retry_count})ï¼Œæ”¾æ£„\")\n",
                "    return None\n",
                "\n",
                "# æ¸¬è©¦\n",
                "print(\"=== æ¸¬è©¦ 1: æ­£å¸¸è«‹æ±‚ ===\")\n",
                "result = fetch_user_data(123)\n",
                "\n",
                "# å¯ä»¥å–æ¶ˆè¨»è§£æ¸¬è©¦å…¶ä»–æƒ…æ³\n",
                "# print(\"\\n=== æ¸¬è©¦ 2: é€¾æ™‚é‡è©¦ ===\")\n",
                "# result = fetch_user_data(456)"
            ]
        },
        {
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "### æ¡ˆä¾‹ 3 çŸ¥è­˜é»ç¸½çµ\n",
                "\n",
                "**é—œéµæŠ€å·§**ï¼š\n",
                "1. **é‡è©¦æ©Ÿåˆ¶**\n",
                "   - æŒ‡æ•¸é€€é¿ï¼ˆExponential Backoffï¼‰\n",
                "   - å€åˆ†å¯é‡è©¦èˆ‡ä¸å¯é‡è©¦çš„éŒ¯èª¤\n",
                "   - è¨­å®šæœ€å¤§é‡è©¦æ¬¡æ•¸\n",
                "\n",
                "2. **éŒ¯èª¤åˆ†é¡è™•ç†**\n",
                "   - é€¾æ™‚éŒ¯èª¤ â†’ é‡è©¦\n",
                "   - é€£ç·šéŒ¯èª¤ â†’ é‡è©¦\n",
                "   - 4xx HTTP éŒ¯èª¤ â†’ ä¸é‡è©¦ï¼ˆå®¢æˆ¶ç«¯éŒ¯èª¤ï¼‰\n",
                "   - 5xx HTTP éŒ¯èª¤ â†’ é‡è©¦ï¼ˆä¼ºæœå™¨éŒ¯èª¤ï¼‰\n",
                "   - JSON éŒ¯èª¤ â†’ ä¸é‡è©¦ï¼ˆè³‡æ–™æ ¼å¼éŒ¯èª¤ï¼‰\n",
                "\n",
                "3. **çœŸå¯¦å°ˆæ¡ˆä¸­çš„æ”¹é€²**\n",
                "```python\n",
                "import requests\n",
                "\n",
                "def fetch_user_data_real(user_id):\n",
                "    try:\n",
                "        response = requests.get(\n",
                "            f\"https://api.example.com/users/{user_id}\",\n",
                "            timeout=5\n",
                "        )\n",
                "        response.raise_for_status()  # æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼\n",
                "        return response.json()\n",
                "    \n",
                "    except requests.Timeout:\n",
                "        # è™•ç†é€¾æ™‚\n",
                "        pass\n",
                "    except requests.ConnectionError:\n",
                "        # è™•ç†é€£ç·šéŒ¯èª¤\n",
                "        pass\n",
                "    except requests.HTTPError as e:\n",
                "        # è™•ç† HTTP éŒ¯èª¤\n",
                "        pass\n",
                "    except requests.RequestException as e:\n",
                "        # è™•ç†å…¶ä»– requests ç›¸é—œéŒ¯èª¤\n",
                "        pass\n",
                "```\n",
                "\n",
                "---"
            ]
        },
        {
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "## æ¡ˆä¾‹ 4ï¼šè³‡æ–™åº«æ“ä½œèˆ‡äº¤æ˜“è™•ç†\n",
                "\n",
                "### æƒ…å¢ƒ\n",
                "å¯¦ä½œä¸€å€‹ç°¡å–®çš„ä½¿ç”¨è€…ç®¡ç†ç³»çµ±ï¼Œä½¿ç”¨ SQLite è³‡æ–™åº«ï¼š\n",
                "- å»ºç«‹è³‡æ–™è¡¨\n",
                "- æ–°å¢ä½¿ç”¨è€…ï¼ˆè™•ç†é‡è¤‡ï¼‰\n",
                "- æ›´æ–°ä½¿ç”¨è€…ï¼ˆäº¤æ˜“å›æ»¾ï¼‰\n",
                "- æŸ¥è©¢ä½¿ç”¨è€…ï¼ˆè™•ç†ä¸å­˜åœ¨ï¼‰\n",
                "- ç¢ºä¿é€£ç·šä¸€å®šé—œé–‰"
            ]
        },
        {
            "cell_type": "code",
            "execution_count": null,
            "metadata": {},
            "outputs": [],
            "source": [
                "import sqlite3\n",
                "from contextlib import contextmanager\n",
                "\n",
                "class UserDatabase:\n",
                "    \"\"\"\n",
                "    ä½¿ç”¨è€…è³‡æ–™åº«ç®¡ç†é¡åˆ¥\n",
                "    ç¤ºç¯„å®Œæ•´çš„è³‡æ–™åº«ä¾‹å¤–è™•ç†\n",
                "    \"\"\"\n",
                "    \n",
                "    def __init__(self, db_file=\":memory:\"):\n",
                "        \"\"\"åˆå§‹åŒ–è³‡æ–™åº«é€£ç·š\"\"\"\n",
                "        self.db_file = db_file\n",
                "        self.conn = None\n",
                "        \n",
                "    def connect(self):\n",
                "        \"\"\"å»ºç«‹è³‡æ–™åº«é€£ç·š\"\"\"\n",
                "        try:\n",
                "            self.conn = sqlite3.connect(self.db_file)\n",
                "            print(f\"âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸ: {self.db_file}\")\n",
                "            return True\n",
                "        except sqlite3.Error as e:\n",
                "            print(f\"âŒ è³‡æ–™åº«é€£ç·šå¤±æ•—: {e}\")\n",
                "            return False\n",
                "    \n",
                "    def create_table(self):\n",
                "        \"\"\"å»ºç«‹ä½¿ç”¨è€…è³‡æ–™è¡¨\"\"\"\n",
                "        try:\n",
                "            cursor = self.conn.cursor()\n",
                "            cursor.execute(\"\"\"\n",
                "                CREATE TABLE IF NOT EXISTS users (\n",
                "                    id INTEGER PRIMARY KEY AUTOINCREMENT,\n",
                "                    username TEXT UNIQUE NOT NULL,\n",
                "                    email TEXT UNIQUE NOT NULL,\n",
                "                    age INTEGER\n",
                "                )\n",
                "            \"\"\")\n",
                "            self.conn.commit()\n",
                "            print(\"âœ… è³‡æ–™è¡¨å»ºç«‹æˆåŠŸ\")\n",
                "            return True\n",
                "        \n",
                "        except sqlite3.Error as e:\n",
                "            print(f\"âŒ å»ºç«‹è³‡æ–™è¡¨å¤±æ•—: {e}\")\n",
                "            return False\n",
                "    \n",
                "    def add_user(self, username, email, age):\n",
                "        \"\"\"\n",
                "        æ–°å¢ä½¿ç”¨è€…\n",
                "        è™•ç†é‡è¤‡çš„ä½¿ç”¨è€…åç¨±æˆ– email\n",
                "        \"\"\"\n",
                "        try:\n",
                "            cursor = self.conn.cursor()\n",
                "            cursor.execute(\n",
                "                \"INSERT INTO users (username, email, age) VALUES (?, ?, ?)\",\n",
                "                (username, email, age)\n",
                "            )\n",
                "            self.conn.commit()\n",
                "            \n",
                "            user_id = cursor.lastrowid\n",
                "            print(f\"âœ… ä½¿ç”¨è€…æ–°å¢æˆåŠŸ: ID={user_id}, {username}\")\n",
                "            return user_id\n",
                "        \n",
                "        except sqlite3.IntegrityError as e:\n",
                "            # é•åå”¯ä¸€æ€§é™åˆ¶ï¼ˆUNIQUE constraintï¼‰\n",
                "            print(f\"âŒ ä½¿ç”¨è€…å·²å­˜åœ¨: {e}\")\n",
                "            return None\n",
                "        \n",
                "        except sqlite3.Error as e:\n",
                "            print(f\"âŒ æ–°å¢ä½¿ç”¨è€…å¤±æ•—: {e}\")\n",
                "            return None\n",
                "    \n",
                "    def update_user_email(self, username, new_email):\n",
                "        \"\"\"\n",
                "        æ›´æ–°ä½¿ç”¨è€… email\n",
                "        ç¤ºç¯„äº¤æ˜“å›æ»¾\n",
                "        \"\"\"\n",
                "        try:\n",
                "            cursor = self.conn.cursor()\n",
                "            \n",
                "            # æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å­˜åœ¨\n",
                "            cursor.execute(\"SELECT id FROM users WHERE username=?\", (username,))\n",
                "            result = cursor.fetchone()\n",
                "            \n",
                "            if not result:\n",
                "                print(f\"âŒ ä½¿ç”¨è€…ä¸å­˜åœ¨: {username}\")\n",
                "                return False\n",
                "            \n",
                "            # æ›´æ–° email\n",
                "            cursor.execute(\n",
                "                \"UPDATE users SET email=? WHERE username=?\",\n",
                "                (new_email, username)\n",
                "            )\n",
                "            self.conn.commit()\n",
                "            print(f\"âœ… Email æ›´æ–°æˆåŠŸ: {username} -> {new_email}\")\n",
                "            return True\n",
                "        \n",
                "        except sqlite3.IntegrityError:\n",
                "            # Email å·²è¢«å…¶ä»–ä½¿ç”¨è€…ä½¿ç”¨\n",
                "            print(f\"âŒ Email å·²è¢«ä½¿ç”¨: {new_email}\")\n",
                "            self.conn.rollback()\n",
                "            return False\n",
                "        \n",
                "        except sqlite3.Error as e:\n",
                "            print(f\"âŒ æ›´æ–°å¤±æ•—: {e}\")\n",
                "            self.conn.rollback()\n",
                "            return False\n",
                "    \n",
                "    def get_user(self, username):\n",
                "        \"\"\"\n",
                "        æŸ¥è©¢ä½¿ç”¨è€…\n",
                "        \"\"\"\n",
                "        try:\n",
                "            cursor = self.conn.cursor()\n",
                "            cursor.execute(\n",
                "                \"SELECT id, username, email, age FROM users WHERE username=?\",\n",
                "                (username,)\n",
                "            )\n",
                "            result = cursor.fetchone()\n",
                "            \n",
                "            if result:\n",
                "                user = {\n",
                "                    \"id\": result[0],\n",
                "                    \"username\": result[1],\n",
                "                    \"email\": result[2],\n",
                "                    \"age\": result[3]\n",
                "                }\n",
                "                print(f\"âœ… æ‰¾åˆ°ä½¿ç”¨è€…: {user}\")\n",
                "                return user\n",
                "            else:\n",
                "                print(f\"âš ï¸  ä½¿ç”¨è€…ä¸å­˜åœ¨: {username}\")\n",
                "                return None\n",
                "        \n",
                "        except sqlite3.Error as e:\n",
                "            print(f\"âŒ æŸ¥è©¢å¤±æ•—: {e}\")\n",
                "            return None\n",
                "    \n",
                "    def close(self):\n",
                "        \"\"\"é—œé–‰è³‡æ–™åº«é€£ç·š\"\"\"\n",
                "        if self.conn:\n",
                "            self.conn.close()\n",
                "            print(\"âœ… è³‡æ–™åº«é€£ç·šå·²é—œé–‰\")\n",
                "\n",
                "# æ¸¬è©¦å®Œæ•´æµç¨‹\n",
                "print(\"=== æ¸¬è©¦è³‡æ–™åº«æ“ä½œ ===\")\n",
                "\n",
                "db = UserDatabase()\n",
                "\n",
                "try:\n",
                "    # 1. é€£ç·š\n",
                "    if not db.connect():\n",
                "        raise Exception(\"ç„¡æ³•é€£ç·šè³‡æ–™åº«\")\n",
                "    \n",
                "    # 2. å»ºç«‹è³‡æ–™è¡¨\n",
                "    db.create_table()\n",
                "    \n",
                "    # 3. æ–°å¢ä½¿ç”¨è€…\n",
                "    print(\"\\n--- æ–°å¢ä½¿ç”¨è€… ---\")\n",
                "    db.add_user(\"alice\", \"alice@example.com\", 25)\n",
                "    db.add_user(\"bob\", \"bob@example.com\", 30)\n",
                "    \n",
                "    # 4. å˜—è©¦æ–°å¢é‡è¤‡ä½¿ç”¨è€…ï¼ˆæœƒå¤±æ•—ï¼‰\n",
                "    print(\"\\n--- æ¸¬è©¦é‡è¤‡ä½¿ç”¨è€… ---\")\n",
                "    db.add_user(\"alice\", \"alice2@example.com\", 26)\n",
                "    \n",
                "    # 5. æŸ¥è©¢ä½¿ç”¨è€…\n",
                "    print(\"\\n--- æŸ¥è©¢ä½¿ç”¨è€… ---\")\n",
                "    db.get_user(\"alice\")\n",
                "    db.get_user(\"nonexistent\")\n",
                "    \n",
                "    # 6. æ›´æ–° email\n",
                "    print(\"\\n--- æ›´æ–° Email ---\")\n",
                "    db.update_user_email(\"alice\", \"alice_new@example.com\")\n",
                "    \n",
                "    # 7. å˜—è©¦ä½¿ç”¨å·²å­˜åœ¨çš„ emailï¼ˆæœƒå¤±æ•—ï¼‰\n",
                "    db.update_user_email(\"alice\", \"bob@example.com\")\n",
                "    \n",
                "finally:\n",
                "    # ç¢ºä¿è³‡æ–™åº«é€£ç·šä¸€å®šæœƒè¢«é—œé–‰\n",
                "    print(\"\\n--- æ¸…ç†è³‡æº ---\")\n",
                "    db.close()"
            ]
        },
        {
            "cell_type": "markdown",
            "metadata": {},
            "source": [
                "### æ¡ˆä¾‹ 4 çŸ¥è­˜é»ç¸½çµ\n",
                "\n",
                "**é—œéµæŠ€å·§**ï¼š\n",
                "\n",
                "1. **SQLite ä¾‹å¤–éšå±¤**\n",
                "```python\n",
                "sqlite3.Error  # æ‰€æœ‰ SQLite ä¾‹å¤–çš„åŸºé¡\n",
                "â”œâ”€â”€ sqlite3.InterfaceError\n",
                "â”œâ”€â”€ sqlite3.DatabaseError\n",
                "â”‚   â”œâ”€â”€ sqlite3.IntegrityError  # é•åå®Œæ•´æ€§é™åˆ¶ï¼ˆUNIQUE, FOREIGN KEY ç­‰ï¼‰\n",
                "â”‚   â”œâ”€â”€ sqlite3.OperationalError  # è³‡æ–™åº«æ“ä½œéŒ¯èª¤\n",
                "â”‚   â””â”€â”€ sqlite3.ProgrammingError  # SQL èªæ³•éŒ¯èª¤\n",
                "â””â”€â”€ ...\n",
                "```\n",
                "\n",
                "2. **äº¤æ˜“è™•ç†**\n",
                "   - `commit()`: ç¢ºèªè®Šæ›´\n",
                "   - `rollback()`: å›æ»¾è®Šæ›´\n",
                "   - éŒ¯èª¤æ™‚å¿…é ˆ rollbackï¼Œé¿å…è³‡æ–™ä¸ä¸€è‡´\n",
                "\n",
                "3. **è³‡æºç®¡ç†**\n",
                "   - ä½¿ç”¨ `try...finally` ç¢ºä¿é€£ç·šé—œé–‰\n",
                "   - æ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨ context manager\n",
                "\n",
                "**æ”¹é€²å»ºè­°ï¼šä½¿ç”¨ Context Manager**\n",
                "```python\n",
                "@contextmanager\n",
                "def get_db_cursor(db_file):\n",
                "    conn = sqlite3.connect(db_file)\n",
                "    try:\n",
                "        yield conn.cursor()\n",
                "        conn.commit()\n",
                "    except Exception:\n",
                "        conn.rollback()\n",
                "        raise\n",
                "    finally:\n",
                "        conn.close()\n",
                "\n",
                "# ä½¿ç”¨\n",
                "with get_db_cursor('users.db') as cursor:\n",
                "    cursor.execute(\"INSERT INTO users ...\")\n",
                "```\n",
                "\n",
                "**å¸¸è¦‹éŒ¯èª¤**ï¼š\n",
                "- âŒ éŒ¯èª¤æ™‚æ²’æœ‰ rollback\n",
                "- âŒ å¿˜è¨˜ commitï¼ˆè®Šæ›´ä¸æœƒä¿å­˜ï¼‰\n",
                "- âŒ æ²’æœ‰é—œé–‰é€£ç·šï¼ˆè³‡æºæ´©æ¼ï¼‰\n",
                "- âŒ ä¸è™•ç† IntegrityErrorï¼ˆé•åé™åˆ¶æ™‚å´©æ½°ï¼‰\n",
                "\n",
                "---\n",
                "\n",
                "## ç¸½çµ\n",
                "\n",
                "æœ¬æª”æ¡ˆå±•ç¤ºäº† 4 å€‹å®Œæ•´çš„ä¾‹å¤–è™•ç†å¯¦å‹™æ¡ˆä¾‹ï¼š\n",
                "\n",
                "1. **ä½¿ç”¨è€…è¼¸å…¥é©—è­‰** - é‡è©¦æ©Ÿåˆ¶ã€å‹å–„éŒ¯èª¤è¨Šæ¯\n",
                "2. **æª”æ¡ˆè™•ç†** - try-except-else-finallyã€è³‡æºç®¡ç†\n",
                "3. **ç¶²è·¯è«‹æ±‚** - é‡è©¦ç­–ç•¥ã€éŒ¯èª¤åˆ†é¡ã€æŒ‡æ•¸é€€é¿\n",
                "4. **è³‡æ–™åº«æ“ä½œ** - äº¤æ˜“è™•ç†ã€IntegrityErrorã€è³‡æºæ¸…ç†\n",
                "\n",
                "**æ ¸å¿ƒåŸå‰‡**ï¼š\n",
                "- âœ… è™•ç†é æœŸçš„éŒ¯èª¤\n",
                "- âœ… æä¾›æ¸…æ¥šçš„éŒ¯èª¤è¨Šæ¯\n",
                "- âœ… å€åˆ†å¯é‡è©¦èˆ‡ä¸å¯é‡è©¦çš„éŒ¯èª¤\n",
                "- âœ… ç¢ºä¿è³‡æºä¸€å®šæœƒè¢«é‡‹æ”¾\n",
                "- âœ… è¨˜éŒ„éŒ¯èª¤ä»¥ä¾¿é™¤éŒ¯\n",
                "\n",
                "**ä¸‹ä¸€æ­¥**ï¼š\n",
                "- ç·´ç¿’ **03-practice.ipynb**\n",
                "- æŒ‘æˆ° **04-exercises.ipynb**"
            ]
        }
    ],
    "metadata": {
        "kernelspec": {
            "display_name": "Python 3",
            "language": "python",
            "name": "python3"
        },
        "language_info": {
            "codemirror_mode": {"name": "ipython", "version": 3},
            "file_extension": ".py",
            "mimetype": "text/x-python",
            "name": "python",
            "nbconvert_exporter": "python",
            "pygments_lexer": "ipython3",
            "version": "3.11.0"
        }
    },
    "nbformat": 4,
    "nbformat_minor": 4
}

# å°‡å…§å®¹å¯«å…¥æª”æ¡ˆ
def write_notebook(path, content):
    with open(path, 'w', encoding='utf-8') as f:
        json.dump(content, f, ensure_ascii=False, indent=1)
    print(f"âœ… å»ºç«‹: {path}")

# Ch20 - 02-worked-examples.ipynb
base_path = r"D:\python_workspace\github\iSpan_python-basic-cookbooks\fundamentals\ch20-exceptions"
write_notebook(os.path.join(base_path, "02-worked-examples.ipynb"), CH20_02_WORKED_EXAMPLES)

print("\nå®Œæˆï¼")
print("å·²å»ºç«‹ Ch20 - 02-worked-examples.ipynb")
print("\nè«‹æ³¨æ„ï¼šç”±æ–¼æª”æ¡ˆå…§å®¹é¾å¤§ï¼Œå…¶ä»–æª”æ¡ˆå°‡ä½¿ç”¨é¡ä¼¼æ–¹å¼å»ºç«‹")
print("å»ºè­°ä½¿ç”¨æ­¤è…³æœ¬ä½œç‚ºç¯„æœ¬ï¼Œç¹¼çºŒå®Œæˆå…¶é¤˜ 19 å€‹æª”æ¡ˆ")
